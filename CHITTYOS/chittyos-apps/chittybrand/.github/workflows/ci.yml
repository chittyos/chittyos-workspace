name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]  # Node LTS versions

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install dependencies
      run: npm ci

    - name: Make CLI executable
      run: chmod +x chitty.js

    - name: Run smoke test
      run: npm run test:smoke

    - name: Test chitty command
      run: node chitty.js --help --yes

    - name: Test ccli alias
      run: node chitty.js --help --yes

    - name: Verify no stale references
      run: |
        ! grep -r "chitty-cli-advanced\.js\|package-cli\.json" . \
          --exclude-dir=node_modules \
          --exclude-dir=.git \
          --exclude="*.md"

    - name: Check executable permissions
      run: test -x chitty.js && echo "✅ chitty.js is executable"

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm ci

    - name: Check for conflicting CLIs
      run: |
        if [ -f "brand-cli-tool.js" ] || [ -f "chitty-cli-advanced.js" ]; then
          echo "❌ Found conflicting CLI files"
          exit 1
        fi
        echo "✅ No conflicting CLI files found"