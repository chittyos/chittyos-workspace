name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        run: |
          title="${{ github.event.pull_request.title }}"

          # Check for conventional commit format
          if echo "$title" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|ci)(\(.+\))?: .+'; then
            echo "‚úÖ PR title follows conventional commit format"
          else
            echo "‚ö†Ô∏è  PR title doesn't follow conventional commit format"
            echo "Expected: type(scope): description"
            echo "Example: feat(api): add ChittyFinance routes"
          fi

  file-changes:
    name: Analyze File Changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed files
        run: |
          changed_files=$(git diff --name-only origin/main...HEAD)

          echo "üìù Changed files:"
          echo "$changed_files"

          # Check if critical files were modified
          if echo "$changed_files" | grep -q "wrangler.toml"; then
            echo "‚ö†Ô∏è  wrangler.toml was modified - requires extra review"
          fi

          if echo "$changed_files" | grep -q "package.json"; then
            echo "‚ö†Ô∏è  package.json was modified - check dependencies"
          fi

          if echo "$changed_files" | grep -q "src/index.js"; then
            echo "‚ö†Ô∏è  Main entry point modified - requires careful review"
          fi

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check worker size
        run: |
          # Count lines of code
          total_lines=$(find src -name "*.js" -exec wc -l {} + | tail -1 | awk '{print $1}')

          echo "üìä Total lines of JavaScript: $total_lines"

          if [ "$total_lines" -gt 5000 ]; then
            echo "‚ö†Ô∏è  Warning: Large worker size ($total_lines lines)"
            echo "Consider splitting into multiple workers or optimizing"
          else
            echo "‚úÖ Worker size is reasonable"
          fi

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f README.md ]; then
            echo "‚ùå README.md is missing"
            exit 1
          fi
          echo "‚úÖ README.md found"

      - name: Check for TODOs in PR
        run: |
          if git diff origin/main...HEAD | grep -i "TODO\|FIXME"; then
            echo "‚ö†Ô∏è  Found TODO/FIXME comments in changes"
            echo "Consider addressing these before merging"
          else
            echo "‚úÖ No TODO/FIXME comments found"
          fi
