name = "chittyevidence-db"
account_id = "0bc21e3a5a9de1a4cc843be9c3e98121"
main = "src/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

# ============================================
# WORKFLOW CONFIGURATION
# ============================================
[[workflows]]
name = "DOCUMENT_WORKFLOW"
class_name = "DocumentProcessingWorkflow"
binding = "DOCUMENT_WORKFLOW"

# ============================================
# DURABLE OBJECTS
# ============================================
[durable_objects]
bindings = [
  { name = "DUPLICATE_HUNTER", class_name = "DuplicateHunterDO" },
  { name = "ACCURACY_GUARDIAN", class_name = "AccuracyGuardianDO" }
]

[[migrations]]
tag = "v1"
new_classes = [ "DuplicateHunterDO", "AccuracyGuardianDO" ]

# ============================================
# D1 DATABASE
# ============================================
[[d1_databases]]
binding = "DB"
database_name = "chittyevidence-db"
database_id = "f486fed7-cba9-47d2-93fb-ca11d90ca084"

# ============================================
# R2 STORAGE
# ============================================
[[r2_buckets]]
binding = "DOCUMENTS"
bucket_name = "chittyevidence-documents"

[[r2_buckets]]
binding = "PROCESSED"
bucket_name = "chittyevidence-processed"

# ============================================
# VECTORIZE INDEX
# ============================================
[[vectorize]]
binding = "VECTORIZE"
index_name = "chittyevidence-embeddings"

# ============================================
# WORKERS AI
# ============================================
[ai]
binding = "AI"

# ============================================
# QUEUES (for batch operations)
# ============================================
[[queues.producers]]
binding = "REPROCESS_QUEUE"
queue = "chittyevidence-reprocess"

[[queues.producers]]
binding = "CORRECTION_QUEUE"
queue = "chittyevidence-corrections"

# Queue consumers temporarily disabled - existing consumers attached
# [[queues.consumers]]
# queue = "chittyevidence-reprocess"
# max_batch_size = 10
# max_retries = 3

# [[queues.consumers]]
# queue = "chittyevidence-corrections"
# max_batch_size = 25
# max_retries = 3

# ============================================
# CRON TRIGGERS
# ============================================
[triggers]
crons = [
  "0 * * * *",      # Hourly: Duplicate Hunter incremental scan
  "*/15 * * * *",   # Every 15 min: Process approved corrections
  "0 3 * * *",      # Daily 3am: Scan for known error patterns
  "0 4 * * *",      # Daily 4am: Check expiring authorities
  "0 0 * * SUN"     # Weekly Sunday midnight: Full corpus duplicate scan
]

# ============================================
# CLOUDFLARE PIPELINES (EDRM-Aligned)
# Electronic Discovery Reference Model terminology
# https://edrm.net/resources/frameworks-and-standards/edrm-model/
# ============================================

# Collection Pipeline - EDRM "Collection" stage
# Gathering potentially relevant documents for review
# Stream ID: 6d71fa5d8a764350b0094cef7f8b5fef
# Pipeline ID: 68da4fbb41ad4ba0858d75359a63545c
[[pipelines]]
pipeline = "6d71fa5d8a764350b0094cef7f8b5fef"
binding = "COLLECTION_PIPELINE"

# Preservation Pipeline - EDRM "Preservation" stage
# Formally securing documents with chain of custody
# Stream ID: 4cd9a96973d3463ab13566dfcdc55efe
# Pipeline ID: 9228d97a991243089e433b5253a3b8c4
[[pipelines]]
pipeline = "4cd9a96973d3463ab13566dfcdc55efe"
binding = "PRESERVATION_PIPELINE"

# ============================================
# ENVIRONMENT VARIABLES
# ============================================
[vars]
ENVIRONMENT = "production"
AUTO_RESOLVE_CONFIDENCE_THRESHOLD = "0.95"
DUPLICATE_AUTO_MERGE_THRESHOLD = "0.98"
MAX_OCR_TIMEOUT_MS = "300000"
CHITTYCONNECT_URL = "https://connect.chitty.cc"
CHITTYCONNECT_TOKEN = "" # Set via wrangler secret

# ============================================
# LOCAL DEVELOPMENT
# ============================================
[dev]
port = 8787
local_protocol = "http"

# Development-specific overrides (bindings inherited from top-level)
[env.dev.vars]
ENVIRONMENT = "development"
AUTO_RESOLVE_CONFIDENCE_THRESHOLD = "0.99"
TEST_API_KEY = "dev-test-key-change-me-in-secrets"

# ============================================
# STAGING ENVIRONMENT
# ============================================
[env.staging]
routes = [
  { pattern = "evidence-staging.chitty.cc/*", zone_name = "chitty.cc" }
]

[env.staging.vars]
ENVIRONMENT = "staging"
AUTO_RESOLVE_CONFIDENCE_THRESHOLD = "0.95"
# Staging test auth - use wrangler secret for real value
# TEST_API_KEY should be set via: wrangler secret put TEST_API_KEY --env staging

# ============================================
# CUSTOM DOMAIN
# ============================================
routes = [
  { pattern = "evidence.chitty.cc/*", zone_name = "chitty.cc" }
]

# ============================================
# LIMITS
# ============================================
[limits]
cpu_ms = 300000  # 5 minutes for OCR-heavy processing
